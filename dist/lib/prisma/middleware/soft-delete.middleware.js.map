{"version":3,"sources":["../../../../src/lib/prisma/middleware/soft-delete.middleware.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\nimport { QueryMiddlewareParams } from '@prisma/client/runtime/library'\nimport dayjs from 'dayjs'\n\nconst date = dayjs().toDate()\n\nfunction softDeleteMiddleware(prisma: PrismaClient) {\n  /***********************************/\n  /* SOFT DELETE MIDDLEWARE */\n  /***********************************/\n  prisma.$use(\n    // @ts-expect-error params type is correct\n    (params: QueryMiddlewareParams, next: (params: QueryMiddlewareParams) => Promise<unknown>) => {\n      if (params.model !== 'user') return next(params)\n\n      // Check incoming query type\n      if (params.action === 'delete') {\n        // Delete queries\n        // Change action to an update\n        params.action = 'update'\n        params.args.data = { deletedAt: date }\n      }\n\n      if (params.action === 'deleteMany') {\n        // Delete many queries\n        params.action = 'updateMany'\n        if (params.args.data !== undefined) {\n          params.args.data.deletedAt = date\n        } else {\n          params.args.data = { deletedAt: date }\n        }\n      }\n\n      if (params.action === 'findUnique') {\n        params.action = 'findFirst'\n        // Add 'deleted' filter\n        // ID filter maintained\n        params.args.where.deletedAt = null\n      }\n\n      if (params.action === 'findMany' || params.action === 'findFirst') {\n        // Find many queries\n        if (params.args.where !== undefined) {\n          if (params.args.where.deletedAt === undefined) {\n            // Exclude deleted records if they have not been explicitly requested\n            params.args.where.deletedAt = null\n          }\n        } else {\n          params.args.where = { deletedAt: null }\n        }\n      }\n\n      return next(params)\n    },\n  )\n}\n\nexport default softDeleteMiddleware\n"],"names":["date","dayjs","toDate","softDeleteMiddleware","prisma","$use","params","next","model","action","args","data","deletedAt","undefined","where"],"mappings":";;;;+BAyDA;;;eAAA;;;8DAvDkB;;;;;;AAElB,MAAMA,OAAOC,IAAAA,cAAK,IAAGC,MAAM;AAE3B,SAASC,qBAAqBC,MAAoB;IAChD,mCAAmC,GACnC,0BAA0B,GAC1B,mCAAmC,GACnCA,OAAOC,IAAI,CACT,0CAA0C;IAC1C,CAACC,QAA+BC;QAC9B,IAAID,OAAOE,KAAK,KAAK,QAAQ,OAAOD,KAAKD;QAEzC,4BAA4B;QAC5B,IAAIA,OAAOG,MAAM,KAAK,UAAU;YAC9B,iBAAiB;YACjB,6BAA6B;YAC7BH,OAAOG,MAAM,GAAG;YAChBH,OAAOI,IAAI,CAACC,IAAI,GAAG;gBAAEC,WAAWZ;YAAK;QACvC;QAEA,IAAIM,OAAOG,MAAM,KAAK,cAAc;YAClC,sBAAsB;YACtBH,OAAOG,MAAM,GAAG;YAChB,IAAIH,OAAOI,IAAI,CAACC,IAAI,KAAKE,WAAW;gBAClCP,OAAOI,IAAI,CAACC,IAAI,CAACC,SAAS,GAAGZ;YAC/B,OAAO;gBACLM,OAAOI,IAAI,CAACC,IAAI,GAAG;oBAAEC,WAAWZ;gBAAK;YACvC;QACF;QAEA,IAAIM,OAAOG,MAAM,KAAK,cAAc;YAClCH,OAAOG,MAAM,GAAG;YAChB,uBAAuB;YACvB,uBAAuB;YACvBH,OAAOI,IAAI,CAACI,KAAK,CAACF,SAAS,GAAG;QAChC;QAEA,IAAIN,OAAOG,MAAM,KAAK,cAAcH,OAAOG,MAAM,KAAK,aAAa;YACjE,oBAAoB;YACpB,IAAIH,OAAOI,IAAI,CAACI,KAAK,KAAKD,WAAW;gBACnC,IAAIP,OAAOI,IAAI,CAACI,KAAK,CAACF,SAAS,KAAKC,WAAW;oBAC7C,qEAAqE;oBACrEP,OAAOI,IAAI,CAACI,KAAK,CAACF,SAAS,GAAG;gBAChC;YACF,OAAO;gBACLN,OAAOI,IAAI,CAACI,KAAK,GAAG;oBAAEF,WAAW;gBAAK;YACxC;QACF;QAEA,OAAOL,KAAKD;IACd;AAEJ;MAEA,WAAeH"}